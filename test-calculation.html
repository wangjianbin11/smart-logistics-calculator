<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµæŠ¥ä»·æœºå™¨äºº - æµ‹è¯•éªŒè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 24px;
        }
        
        .test-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            background: #fafafa;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .test-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .test-item h3 {
            color: #555;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .test-params {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        
        .test-result {
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
            background: #f1f8e9;
            font-size: 13px;
        }
        
        .test-result.error {
            border-left-color: #f44336;
            background: #fff5f5;
            color: #c62828;
        }
        
        .test-result.success {
            color: #2e7d32;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 13px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .comparison-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        .best-price {
            background: #e8f5e8 !important;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-success {
            background: #4caf50;
        }
        
        .status-error {
            background: #f44336;
        }
        
        .status-loading {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 4px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .company-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .company-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .company-card h4 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .service-count {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }
        
        .service-list {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç‰©æµæŠ¥ä»·æœºå™¨äººæµ‹è¯•éªŒè¯</h1>
            <p>éªŒè¯æ•°æ®åº“å®Œæ•´æ€§ â€¢ æµ‹è¯•è®¡ç®—ç²¾åº¦ â€¢ æ¯”ä»·åŠŸèƒ½æ£€æŸ¥</p>
        </div>
        
        <div class="content">
            <!-- æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ -->
            <div class="test-section">
                <h2>ğŸ“Š æ•°æ®åº“çŠ¶æ€æ£€æŸ¥</h2>
                <div id="database-status">
                    <span class="status-indicator status-loading"></span>
                    æ­£åœ¨åŠ è½½æ•°æ®åº“...
                </div>
                
                <div class="company-summary" id="company-summary">
                    <!-- åŠ¨æ€ç”Ÿæˆå…¬å¸ä¿¡æ¯ -->
                </div>
            </div>
            
            <!-- åŸºç¡€è®¡ç®—æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ§® åŸºç¡€è®¡ç®—æµ‹è¯•</h2>
                <p>éªŒè¯æ‚¨æä¾›çš„è®¡ç®—ç¤ºä¾‹ï¼šäº‘é€”ç‰©æµæ ‡å‡†å¸¦ç”µåˆ°åŠ æ‹¿å¤§ï¼Œ0.5kg = 0.5Ã—108+25 = 79å…ƒ</p>
                
                <div class="test-grid" id="basic-tests">
                    <!-- åŠ¨æ€ç”Ÿæˆæµ‹è¯•é¡¹ -->
                </div>
            </div>
            
            <!-- é‡é‡åŒºé—´æµ‹è¯• -->
            <div class="test-section">
                <h2>âš–ï¸ é‡é‡åŒºé—´æµ‹è¯•</h2>
                <p>æµ‹è¯•ä¸åŒé‡é‡ä¸‹çš„ä»·æ ¼åŒºé—´åŒ¹é…</p>
                
                <div class="test-grid" id="weight-tests">
                    <!-- åŠ¨æ€ç”Ÿæˆé‡é‡æµ‹è¯• -->
                </div>
            </div>
            
            <!-- æ¯”ä»·åŠŸèƒ½æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ” æ¯”ä»·åŠŸèƒ½æµ‹è¯•</h2>
                <p>æµ‹è¯•ç¾å›½1.0kgæ™®è´§çš„å…¨å¹³å°æ¯”ä»·</p>
                
                <table class="comparison-table" id="comparison-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>ç‰©æµå…¬å¸</th>
                            <th>æœåŠ¡ç±»å‹</th>
                            <th>æ€»ä»·æ ¼</th>
                            <th>å…¬æ–¤è´¹</th>
                            <th>æ“ä½œè´¹</th>
                            <th>æ—¶æ•ˆ</th>
                            <th>è®¡ç®—å…¬å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- åŠ¨æ€ç”Ÿæˆæ¯”ä»·ç»“æœ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†åŒºæµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ—ºï¸ åˆ†åŒºç³»ç»Ÿæµ‹è¯•</h2>
                <p>æµ‹è¯•æ¾³å¤§åˆ©äºšå„åˆ†åŒºçš„ä»·æ ¼è®¡ç®—</p>
                
                <div class="test-grid" id="zone-tests">
                    <!-- åŠ¨æ€ç”Ÿæˆåˆ†åŒºæµ‹è¯• -->
                </div>
            </div>
            
            <!-- æ‰‹åŠ¨æµ‹è¯•åŒºåŸŸ -->
            <div class="test-section">
                <h2>ğŸ¯ æ‰‹åŠ¨æµ‹è¯•åŒºåŸŸ</h2>
                <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button onclick="runAllTests()">ğŸ”„ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                    <button onclick="testSpecificCase()">ğŸ¯ æµ‹è¯•ç‰¹å®šæ¡ˆä¾‹</button>
                    <button onclick="testRandomCases()">ğŸ² éšæœºæµ‹è¯•</button>
                    <button onclick="exportTestReport()">ğŸ“‹ å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
                </div>
                
                <div id="manual-test-results">
                    <!-- æ‰‹åŠ¨æµ‹è¯•ç»“æœ -->
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="scripts/enhanced-database.js"></script>
    
    <script>
        // æµ‹è¯•ç®¡ç†å™¨
        class TestManager {
            constructor() {
                this.testResults = [];
                this.database = null;
                this.init();
            }
            
            async init() {
                // ç­‰å¾…æ•°æ®åº“åŠ è½½
                await this.waitForDatabase();
                this.database = window.logisticsDB;
                
                // è¿è¡Œåˆå§‹æµ‹è¯•
                this.checkDatabaseStatus();
                this.runBasicTests();
                this.runWeightTests();
                this.runComparisonTest();
                this.runZoneTests();
            }
            
            async waitForDatabase() {
                return new Promise((resolve) => {
                    const checkDB = () => {
                        if (window.logisticsDB) {
                            resolve();
                        } else {
                            setTimeout(checkDB, 100);
                        }
                    };
                    checkDB();
                });
            }
            
            // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
            checkDatabaseStatus() {
                const statusDiv = document.getElementById('database-status');
                const summaryDiv = document.getElementById('company-summary');
                
                if (!this.database) {
                    statusDiv.innerHTML = '<span class="status-indicator status-error"></span>æ•°æ®åº“åŠ è½½å¤±è´¥';
                    return;
                }
                
                const companies = this.database.getCompanies();
                statusDiv.innerHTML = `<span class="status-indicator status-success"></span>æ•°æ®åº“åŠ è½½æˆåŠŸ (${companies.length}å®¶ç‰©æµå…¬å¸)`;
                
                // ç”Ÿæˆå…¬å¸æ‘˜è¦
                let summaryHTML = '';
                companies.forEach(company => {
                    const services = this.database.getServices(company);
                    let countryCount = 0;
                    
                    services.forEach(service => {
                        countryCount += this.database.getCountries(company, service).length;
                    });
                    
                    summaryHTML += `
                        <div class="company-card">
                            <h4>${company}</h4>
                            <div class="service-count">${services.length}</div>
                            <div class="service-list">
                                ${services.join(' â€¢ ')}<br>
                                <small>${countryCount}ä¸ªç›®çš„åœ°</small>
                            </div>
                        </div>
                    `;
                });
                
                summaryDiv.innerHTML = summaryHTML;
            }
            
            // åŸºç¡€è®¡ç®—æµ‹è¯•
            runBasicTests() {
                const testsDiv = document.getElementById('basic-tests');
                const testCases = [
                    {
                        name: 'äº‘é€”æ ‡å‡†å¸¦ç”µ-åŠ æ‹¿å¤§éªŒè¯',
                        company: 'äº‘é€”ç‰©æµ',
                        service: 'æ ‡å‡†å¸¦ç”µ',
                        country: 'åŠ æ‹¿å¤§',
                        weight: 0.5,
                        expected: 79,
                        description: 'éªŒè¯ç”¨æˆ·æä¾›çš„è®¡ç®—ç¤ºä¾‹'
                    },
                    {
                        name: 'ä¸‡é‚¦æœè£…ä¸“çº¿-ç¾å›½',
                        company: 'ä¸‡é‚¦ç‰©æµ',
                        service: 'æœè£…ä¸“çº¿',
                        country: 'ç¾å›½',
                        weight: 0.3,
                        expected: null,
                        description: 'æµ‹è¯•ä¸‡é‚¦æœè£…ä¸“çº¿è®¡ç®—'
                    },
                    {
                        name: 'åç¿°æ™®è´§é«˜ä»¿-ç¾å›½',
                        company: 'åç¿°ç‰©æµ',
                        service: 'æ™®è´§é«˜ä»¿ä¸“çº¿',
                        country: 'ç¾å›½',
                        weight: 0.15,
                        expected: null,
                        description: 'æµ‹è¯•åç¿°ç‰©æµè®¡ç®—'
                    }
                ];
                
                let testsHTML = '';
                testCases.forEach(testCase => {
                    const result = this.database.calculateShipping(
                        testCase.company,
                        testCase.service,
                        testCase.country,
                        testCase.weight
                    );
                    
                    let resultHTML = '';
                    let isSuccess = false;
                    
                    if (result.success) {
                        isSuccess = true;
                        const isExpectedMatch = testCase.expected ? 
                            Math.abs(result.totalCost - testCase.expected) < 0.01 : true;
                        
                        resultHTML = `
                            <div class="test-result ${isExpectedMatch ? 'success' : 'error'}">
                                <strong>âœ… è®¡ç®—æˆåŠŸ</strong><br>
                                æ€»è´¹ç”¨: Â¥${result.totalCost}<br>
                                å…¬å¼: ${result.formula}<br>
                                æ—¶æ•ˆ: ${result.timeframe}<br>
                                é‡é‡æ®µ: ${result.weightRange}
                                ${testCase.expected ? 
                                    `<br><small>æœŸæœ›å€¼: Â¥${testCase.expected} ${isExpectedMatch ? 'âœ…åŒ¹é…' : 'âŒä¸åŒ¹é…'}</small>` 
                                    : ''
                                }
                            </div>
                        `;
                    } else {
                        resultHTML = `
                            <div class="test-result error">
                                <strong>âŒ è®¡ç®—å¤±è´¥</strong><br>
                                é”™è¯¯: ${result.error}
                            </div>
                        `;
                    }
                    
                    testsHTML += `
                        <div class="test-item">
                            <h3>
                                <span class="status-indicator ${isSuccess ? 'status-success' : 'status-error'}"></span>
                                ${testCase.name}
                            </h3>
                            <div class="test-params">
                                å…¬å¸: ${testCase.company}<br>
                                æœåŠ¡: ${testCase.service}<br>
                                ç›®çš„åœ°: ${testCase.country}<br>
                                é‡é‡: ${testCase.weight}kg
                            </div>
                            ${resultHTML}
                        </div>
                    `;
                });
                
                testsDiv.innerHTML = testsHTML;
            }
            
            // é‡é‡åŒºé—´æµ‹è¯•
            runWeightTests() {
                const testsDiv = document.getElementById('weight-tests');
                const weights = [0.1, 0.3, 0.5, 1.0, 2.0, 5.0];
                
                let testsHTML = '';
                weights.forEach(weight => {
                    const result = this.database.calculateShipping(
                        'äº‘é€”ç‰©æµ',
                        'æ ‡å‡†å¸¦ç”µ',
                        'è‹±å›½',
                        weight
                    );
                    
                    let resultHTML = '';
                    if (result.success) {
                        resultHTML = `
                            <div class="test-result success">
                                <strong>âœ… ${weight}kg</strong><br>
                                æ€»è´¹ç”¨: Â¥${result.totalCost}<br>
                                å…¬æ–¤è´¹: Â¥${result.perKgRate}/kg<br>
                                æ“ä½œè´¹: Â¥${result.handlingFee}<br>
                                é‡é‡æ®µ: ${result.weightRange}
                            </div>
                        `;
                    } else {
                        resultHTML = `
                            <div class="test-result error">
                                <strong>âŒ ${weight}kg</strong><br>
                                ${result.error}
                            </div>
                        `;
                    }
                    
                    testsHTML += `
                        <div class="test-item">
                            <h3>é‡é‡ ${weight}kg æµ‹è¯•</h3>
                            ${resultHTML}
                        </div>
                    `;
                });
                
                testsDiv.innerHTML = testsHTML;
            }
            
            // æ¯”ä»·æµ‹è¯•
            runComparisonTest() {
                const tableBody = document.querySelector('#comparison-table tbody');
                const results = this.database.compareAllPrices('ç¾å›½', 1.0, 'æ™®è´§');
                
                let tableHTML = '';
                results.forEach((result, index) => {
                    const isBest = index === 0;
                    tableHTML += `
                        <tr class="${isBest ? 'best-price' : ''}">
                            <td>${index + 1}${isBest ? ' ğŸ†' : ''}</td>
                            <td>${result.company}</td>
                            <td>${result.service}</td>
                            <td><strong>Â¥${result.totalCost}</strong></td>
                            <td>Â¥${result.perKgRate}/kg</td>
                            <td>Â¥${result.handlingFee}</td>
                            <td>${result.timeframe}</td>
                            <td><small>${result.formula}</small></td>
                        </tr>
                    `;
                });
                
                if (results.length === 0) {
                    tableHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">æœªæ‰¾åˆ°åŒ¹é…çš„æœåŠ¡</td></tr>';
                }
                
                tableBody.innerHTML = tableHTML;
            }
            
            // åˆ†åŒºæµ‹è¯•
            runZoneTests() {
                const testsDiv = document.getElementById('zone-tests');
                const zones = ['1åŒº', '2åŒº', '3åŒº', '4åŒº'];
                
                let testsHTML = '';
                zones.forEach(zone => {
                    const result = this.database.calculateShipping(
                        'ä¸‡é‚¦ç‰©æµ',
                        'ä¸“çº¿å¸¦ç”µ',
                        'æ¾³å¤§åˆ©äºš',
                        1.0,
                        zone
                    );
                    
                    let resultHTML = '';
                    if (result.success) {
                        resultHTML = `
                            <div class="test-result success">
                                <strong>âœ… æ¾³å¤§åˆ©äºš${zone}</strong><br>
                                æ€»è´¹ç”¨: Â¥${result.totalCost}<br>
                                å…¬å¼: ${result.formula}<br>
                                æ—¶æ•ˆ: ${result.timeframe}
                            </div>
                        `;
                    } else {
                        resultHTML = `
                            <div class="test-result error">
                                <strong>âŒ æ¾³å¤§åˆ©äºš${zone}</strong><br>
                                ${result.error}
                            </div>
                        `;
                    }
                    
                    testsHTML += `
                        <div class="test-item">
                            <h3>æ¾³å¤§åˆ©äºš ${zone}</h3>
                            ${resultHTML}
                        </div>
                    `;
                });
                
                testsDiv.innerHTML = testsHTML;
            }
        }
        
        // å…¨å±€æµ‹è¯•å‡½æ•°
        function runAllTests() {
            location.reload();
        }
        
        function testSpecificCase() {
            const company = prompt('ç‰©æµå…¬å¸:');
            const service = prompt('æœåŠ¡ç±»å‹:');
            const country = prompt('ç›®çš„å›½å®¶:');
            const weight = parseFloat(prompt('é‡é‡(kg):'));
            const zone = prompt('åˆ†åŒº(å¯é€‰):') || null;
            
            if (company && service && country && weight) {
                const result = window.logisticsDB.calculateShipping(company, service, country, weight, zone);
                const resultDiv = document.getElementById('manual-test-results');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            <h3>âœ… æµ‹è¯•æˆåŠŸ</h3>
                            <p><strong>å…¬å¸:</strong> ${result.company}</p>
                            <p><strong>æœåŠ¡:</strong> ${result.service}</p>
                            <p><strong>ç›®çš„åœ°:</strong> ${result.country}${result.zone ? ' ' + result.zone : ''}</p>
                            <p><strong>é‡é‡:</strong> ${result.weight}kg</p>
                            <p><strong>æ€»è´¹ç”¨:</strong> Â¥${result.totalCost}</p>
                            <p><strong>å…¬å¼:</strong> ${result.formula}</p>
                            <p><strong>æ—¶æ•ˆ:</strong> ${result.timeframe}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            <h3>âŒ æµ‹è¯•å¤±è´¥</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
            }
        }
        
        function testRandomCases() {
            const companies = window.logisticsDB.getCompanies();
            const weights = [0.1, 0.3, 0.5, 1.0, 2.0];
            const resultsDiv = document.getElementById('manual-test-results');
            
            let html = '<h3>ğŸ² éšæœºæµ‹è¯•ç»“æœ</h3>';
            
            for (let i = 0; i < 5; i++) {
                const company = companies[Math.floor(Math.random() * companies.length)];
                const services = window.logisticsDB.getServices(company);
                const service = services[Math.floor(Math.random() * services.length)];
                const countries = window.logisticsDB.getCountries(company, service);
                const country = countries[Math.floor(Math.random() * countries.length)];
                const weight = weights[Math.floor(Math.random() * weights.length)];
                
                const result = window.logisticsDB.calculateShipping(company, service, country, weight);
                
                html += `
                    <div class="test-item" style="margin: 8px 0;">
                        <strong>${company} - ${service} - ${country} - ${weight}kg</strong><br>
                        ${result.success ? 
                            `âœ… Â¥${result.totalCost} (${result.formula})` : 
                            `âŒ ${result.error}`
                        }
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function exportTestReport() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const report = {
                timestamp: new Date().toISOString(),
                database: {
                    companies: window.logisticsDB.getCompanies().length,
                    status: 'loaded'
                },
                tests: testManager.testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logistics-test-report-${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åˆå§‹åŒ–æµ‹è¯•ç®¡ç†å™¨
        let testManager;
        document.addEventListener('DOMContentLoaded', () => {
            testManager = new TestManager();
        });
    </script>
</body>
</html>